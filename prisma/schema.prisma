// SULI Connect - Prisma Schema
// Hierarchical operations platform for rural village management

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  DOMAIN_HEAD
  TEAM_LEAD
  SENIOR_WORKER
  WORKER
  VOLUNTEER
  VISITOR
}

enum TaskStatus {
  NOT_STARTED
  IN_PROGRESS
  BLOCKED
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
}

// Onboarding purpose: Creator, Developer, Investor, Gamer, Other
enum OnboardingPurpose {
  Creator
  Developer
  Investor
  Gamer
  Other
}

enum AttendanceEventType {
  CHECK_IN
  CHECK_OUT
}

enum DeviceType {
  MOBILE
  DESKTOP
}

enum DailySummaryStatus {
  PRESENT
  PARTIAL
  ABSENT
  NEEDS_VERIFICATION
}

// ============================================================================
// USERS & HIERARCHY
// ============================================================================

model User {
  id                String    @id @default(cuid())
  phone             String?   @unique
  email             String?   @unique
  username          String?   @unique
  walletAddress     String?   @unique @map("wallet_address")
  name              String
  fullName          String?   @map("full_name")
  avatarUrl         String?   @map("avatar_url")
  profileImageUrl   String?   @map("profile_image_url")
  bio               String?
  role              UserRole
  purpose           OnboardingPurpose? // Creator, Developer, Investor, Gamer, Other
  passwordHash      String?   @map("password_hash")
  isActive          Boolean   @default(true) @map("is_active")
  onboardingCompleted Boolean @default(false) @map("onboarding_completed")
  authProvider      String?   @map("auth_provider") // google, email, wallet
  lastLoginAt       DateTime? @map("last_login_at")
  deletedAt         DateTime? @map("deleted_at") // Soft delete

  // Hierarchy
  domainId          String?   @map("domain_id")
  teamId            String?   @map("team_id")
  reportingManagerId String?  @map("reporting_manager_id")

  // Relations
  domain            Domain?   @relation(fields: [domainId], references: [id])
  team              Team?     @relation(fields: [teamId], references: [id])
  reportingManager  User?     @relation("ReportingHierarchy", fields: [reportingManagerId], references: [id])
  directReports     User[]    @relation("ReportingHierarchy")
  ledTeam           Team?     @relation("TeamLead")

  // Task relations
  assignedTasks     TaskAssignment[]
  taskUpdates       TaskUpdate[]
  verificationsGiven TaskVerification[] @relation("ValidatorVerifications")
  tasksVerified     TaskVerification[]  @relation("AssigneeVerifications")

  // Attendance
  attendances             Attendance[]
  attendanceEvents        AttendanceEvent[]
  attendanceDailySummaries AttendanceDailySummary[]

  // Reputation (derived, stored for performance)
  reputationScore   Int       @default(0) @map("reputation_score")
  reputationLogs    ReputationLog[]

  // Stats (denormalized for fast /me)
  tasksCompletedCount Int     @default(0) @map("tasks_completed_count")
  daysWorkedCount     Int     @default(0) @map("days_worked_count")

  // Audit & notifications
  auditLogs         AuditLog[]
  notifications     Notification[]

  // Auth: OAuth providers & sessions
  providers         AuthProvider[]
  sessions          AuthSession[]

  // Onboarding - full multi-step payload (JSON)
  onboardingData    Json?     @map("onboarding_data")

  // Onboarding (legacy - kept for backward compat)
  onboardingProfile OnboardingProfile?

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

model OnboardingProfile {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  data      Json     // Full onboarding payload
  completedAt DateTime @default(now()) @map("completed_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("onboarding_profiles")
}

// ============================================================================
// AUTH: Providers, Sessions, OTP, Wallet Nonce
// ============================================================================

model AuthProvider {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  provider     String   // 'google' | 'phone' | 'wallet'
  providerId   String   @map("provider_id") // Google sub, phone, or wallet address
  accessToken  String?  @map("access_token")
  refreshToken String?  @map("refresh_token")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([provider, providerId])
  @@map("auth_providers")
}

model AuthSession {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  refreshTokenHash String  @map("refresh_token_hash")
  deviceInfo      String?  @map("device_info") // JSON
  userAgent       String?  @map("user_agent")
  ipAddress       String?  @map("ip_address")
  expiresAt       DateTime @map("expires_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now()) @map("created_at")

  @@map("auth_sessions")
}

model AuthOtp {
  id        String   @id @default(cuid())
  phone     String
  hashedOtp String   @map("hashed_otp")
  expiresAt DateTime @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("auth_otps")
}

model AuthWalletNonce {
  id        String   @id @default(cuid())
  address   String
  nonce     String
  expiresAt DateTime @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([address])
  @@map("auth_wallet_nonces")
}

// ============================================================================
// DOMAINS & TEAMS
// ============================================================================

model Domain {
  id          String   @id @default(cuid())
  name        String
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  deletedAt   DateTime? @map("deleted_at")

  users       User[]
  teams       Team[]
  tasks       Task[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("domains")
}

model Team {
  id          String   @id @default(cuid())
  name        String
  domainId    String   @map("domain_id")
  leadId      String?  @unique @map("lead_id")
  isActive    Boolean  @default(true) @map("is_active")
  deletedAt   DateTime? @map("deleted_at")

  domain      Domain   @relation(fields: [domainId], references: [id])
  lead        User?    @relation("TeamLead", fields: [leadId], references: [id])
  users       User[]
  tasks       Task[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([domainId, name])
  @@map("teams")
}

// ============================================================================
// SULI LOCATIONS (geofencing for check-in/check-out)
// ============================================================================

model SuliLocation {
  id             String   @id @default(cuid())
  name           String   // e.g. "SULI Village Center"
  latitude       Float    @map("latitude")
  longitude      Float    @map("longitude")
  radiusMetres   Float    @map("radius_metres") // Geofence radius
  isActive       Boolean  @default(true) @map("is_active")

  attendances      Attendance[]
  attendanceEvents AttendanceEvent[]

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("suli_locations")
}

// ============================================================================
// ATTENDANCE
// ============================================================================

model Attendance {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  date         DateTime  @db.Date
  checkInAt    DateTime? @map("check_in_at")
  checkOutAt   DateTime? @map("check_out_at")
  isOverridden Boolean   @default(false) @map("is_overridden")
  overrideBy   String?   @map("override_by")
  overrideReason String? @map("override_reason")

  // Check-in location
  latitude     Float?    @map("latitude")
  longitude    Float?    @map("longitude")
  accuracy     Float?    @map("accuracy") // metres
  note         String?   @map("note")

  // Check-out location
  checkoutLatitude   Float?    @map("checkout_latitude")
  checkoutLongitude  Float?    @map("checkout_longitude")
  checkoutAccuracy   Float?    @map("checkout_accuracy")
  checkoutNote       String?   @map("checkout_note")

  // SULI location used (geofence validated)
  suliLocationId     String?   @map("suli_location_id")
  suliLocation       SuliLocation? @relation(fields: [suliLocationId], references: [id])

  // Allowance (populated on check-out or batch)
  allowanceAmount    Decimal?  @map("allowance_amount") @db.Decimal(12, 2)
  allowanceCurrency  String?   @map("allowance_currency") // e.g. "INR"
  allowanceType      String?   @map("allowance_type") // e.g. "daily", "half_day"

  user         User      @relation(fields: [userId], references: [id])

  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@unique([userId, date])
  @@map("attendance")
}

// ============================================================================
// ATTENDANCE EVENTS (append-only, immutable)
// ============================================================================

model AttendanceEvent {
  id          String              @id @default(cuid())
  userId      String              @map("user_id")
  eventType   AttendanceEventType @map("event_type")
  timestamp   DateTime            @default(now()) @map("timestamp")
  latitude    Decimal?            @map("latitude") @db.Decimal(10, 7)
  longitude   Decimal?            @map("longitude") @db.Decimal(10, 7)
  accuracy    Float?              @map("accuracy") // metres
  locationId  String?             @map("location_id") // SULI location / work area
  taskId      String?             @map("task_id")
  deviceType  DeviceType          @default(MOBILE) @map("device_type")

  user        User                @relation(fields: [userId], references: [id])
  suliLocation SuliLocation?      @relation(fields: [locationId], references: [id])
  task        Task?               @relation(fields: [taskId], references: [id])

  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")

  @@map("attendance_events")
}

// ============================================================================
// ATTENDANCE DAILY SUMMARY (computed from events)
// ============================================================================

model AttendanceDailySummary {
  id                  String             @id @default(cuid())
  userId              String             @map("user_id")
  date                DateTime           @db.Date
  firstCheckIn        DateTime?          @map("first_check_in")
  lastCheckOut        DateTime?          @map("last_check_out")
  totalWorkMinutes    Int                @default(0) @map("total_work_minutes")
  totalBreakMinutes   Int                @default(0) @map("total_break_minutes")
  sessionsCount       Int                @default(0) @map("sessions_count")
  status              DailySummaryStatus @map("status")

  user                User               @relation(fields: [userId], references: [id])

  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")

  @@unique([userId, date])
  @@map("attendance_daily_summary")
}

// ============================================================================
// TASKS
// ============================================================================

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  domainId    String     @map("domain_id")
  teamId      String     @map("team_id")
  status      TaskStatus @default(NOT_STARTED)

  domain      Domain     @relation(fields: [domainId], references: [id])
  team        Team       @relation(fields: [teamId], references: [id])

  assignments     TaskAssignment[]
  updates         TaskUpdate[]
  verifications   TaskVerification[]
  attendanceEvents AttendanceEvent[]

  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  deletedAt   DateTime?  @map("deleted_at")

  @@map("tasks")
}

model TaskAssignment {
  id         String   @id @default(cuid())
  taskId     String   @map("task_id")
  userId     String   @map("user_id")
  isValidator Boolean @default(false) @map("is_validator") // Can verify this task

  task       Task     @relation(fields: [taskId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([taskId, userId])
  @@map("task_assignments")
}

model TaskUpdate {
  id        String   @id @default(cuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  comment   String?
  proofUrls String[] @map("proof_urls") // URLs to proof (photos, documents)
  statusChange TaskStatus? @map("status_change")

  task      Task     @relation(fields: [taskId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("task_updates")
}

model TaskVerification {
  id          String   @id @default(cuid())
  taskId      String   @map("task_id")
  assigneeId  String   @map("assignee_id") // User whose task was verified
  validatorId String   @map("validator_id") // User who verified
  approved    Boolean  // true = VERIFIED, false = REJECTED
  comment     String?
  isAdminOverride Boolean @default(false) @map("is_admin_override")

  task        Task     @relation(fields: [taskId], references: [id])
  assignee    User     @relation("AssigneeVerifications", fields: [assigneeId], references: [id])
  validator   User     @relation("ValidatorVerifications", fields: [validatorId], references: [id])

  createdAt   DateTime @default(now()) @map("created_at")

  @@map("task_verifications")
}

// ============================================================================
// REPUTATION (append-only logs)
// ============================================================================

model ReputationLog {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  delta      Int      // Change in reputation (+/-)
  reason     String   // e.g. "VERIFIED_TASK", "ATTENDANCE_CONSISTENCY", "VERIFICATION_ACCURACY"
  referenceId String? @map("reference_id") // Task/Attendance ID for audit

  user       User     @relation(fields: [userId], references: [id])

  createdAt  DateTime @default(now()) @map("created_at")

  @@map("reputation_logs")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  title     String
  body      String?
  isRead    Boolean   @default(false) @map("is_read")

  user      User      @relation(fields: [userId], references: [id])

  createdAt DateTime  @default(now()) @map("created_at")

  @@map("notifications")
}

// ============================================================================
// AUDIT LOGS (all admin actions)
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String   @map("actor_id")
  action     String   // e.g. "USER_UPDATE", "ATTENDANCE_OVERRIDE"
  entityType String   @map("entity_type") // e.g. "user", "attendance"
  entityId   String?  @map("entity_id")
  payload    String?  // JSON of changes
  ipAddress  String?  @map("ip_address")

  actor      User     @relation(fields: [actorId], references: [id])

  createdAt  DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
}
